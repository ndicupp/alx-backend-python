Custom Manager for Unread Messages
1. Add read Field to the Message Model
# models.py
from django.db import models
from django.contrib.auth.models import User


class Message(models.Model):
    sender = models.ForeignKey(User, on_delete=models.CASCADE, related_name="sent_messages")
    receiver = models.ForeignKey(User, on_delete=models.CASCADE, related_name="received_messages")
    content = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)

    # NEW FIELD
    read = models.BooleanField(default=False)

    objects = models.Manager()  # default manager (keep it!)
    unread = None  # placeholder — we will attach the custom manager below

    def __str__(self):
        return f"Message from {self.sender} to {self.receiver}"

2. Create the Custom Manager: UnreadMessagesManager

This manager filters only unread messages for a specific user.
# managers.py
from django.db import models

class UnreadMessagesManager(models.Manager):
    def for_user(self, user):
        """
        Returns unread messages for a specific user.
        Optimized using .only() to load only necessary fields.
        """
        return (
            super()
            .get_queryset()
            .filter(receiver=user, read=False)
            .only("id", "sender", "content", "timestamp")  # optimization
        )


3. Attach the Custom Manager to Your Model

Update the Message model like this:
# models.py
from .managers import UnreadMessagesManager

class Message(models.Model):
    ...
    read = models.BooleanField(default=False)

    objects = models.Manager()
    unread = UnreadMessagesManager()   # attach custom manager

4. Use It in Your Views

Example inbox view showing only unread messages:
# views.py
from django.shortcuts import render
from .models import Message

def inbox(request):
    unread_messages = Message.unread.for_user(request.user)

    return render(request, "messages/inbox.html", {
        "messages": unread_messages
    })

✔ This will return only unread messages
✔ Optimized by .only() so we don’t fetch unnecessary fields
✔ Clean and reusable

5. Example Template Display
<!-- templates/messages/inbox.html -->
<h2>Unread Messages</h2>

{% for msg in messages %}
    <div>
        <strong>From:</strong> {{ msg.sender.username }}<br>
        <p>{{ msg.content }}</p>
        <small>{{ msg.timestamp }}</small>
    </div>
{% empty %}
    <p>No unread messages.</p>
{% endfor %}



